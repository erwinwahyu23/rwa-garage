generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================= ENUM ================= 

enum UserRole {
  SUPERADMIN
  ADMIN
  MEKANIK
}

enum VisitStatus {
  ANTRI
  PROSES
  SELESAI
  BATAL
}

// ================= MODEL ================= 

model User {
  id       String   @id @default(uuid())
  name     String
  username String   @unique
  password String
  role     UserRole
  isActive Boolean  @default(true)

  // Hierarchy
  createdById String?
  createdBy   User?   @relation("UserHierarchy", fields: [createdById], references: [id])
  createdUsers User[] @relation("UserHierarchy")

  // Relasi sebagai mekanik
  visits Visit[] @relation("MechanicVisits")

  // Kendaraan yang dibuat user
  vehiclesCreated Vehicle[] @relation("UserVehicles")

  // Kunjungan yang dibuat user (createdBy)
  createdVisits Visit[] @relation("CreatedVisits")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Vehicle {
  id           String  @id @default(uuid())
  engineNumber String  @unique
  licensePlate String? // Nomor Polisi / Plat
  brand        String
  model        String?
  year         Int?
  ownerName    String?
  phoneNumber  String?

  createdById String?
  createdBy   User?   @relation("UserVehicles", fields: [createdById], references: [id])

  visits Visit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerName])
  @@index([brand])
  @@index([licensePlate])
}

model Visit {
  id String @id @default(uuid())

  // nomor kunjungan / antrian
  visitNumber String @unique

  // tanggal kunjungan
  visitDate DateTime @default(now())

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  mechanicId String?
  mechanic   User?   @relation("MechanicVisits", fields: [mechanicId], references: [id])

  createdById String?
  createdBy   User?   @relation("CreatedVisits", fields: [createdById], references: [id])

  complaint String?
  status    VisitStatus @default(ANTRI)

  // waktu selesai
  finishedAt DateTime?

  // 1 visit 1 diagnosis
  keluhan     String? @db.Text
  diagnosis   String? @db.Text
  pemeriksaan String? @db.Text
  sparepart   String? @db.Text
  perbaikan   String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices   Invoice[]
  items      VisitItem[]

  @@index([status])
  @@index([createdAt])
  @@index([vehicleId])
  @@index([mechanicId])
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  visitId       String
  visit         Visit         @relation(fields: [visitId], references: [id])
  totalAmount   Decimal       @db.Decimal(12, 2)
  ppn           Float         @default(0) // Percentage
  status        InvoiceStatus @default(UNPAID)
  paymentMethod String?       // CASH, TRANSFER
  notes         String?
  items         Json?         // Snapshot of items at time of invoice
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

enum InvoiceStatus {
  UNPAID
  PAID
  VOID
}

// ================= INVENTORY MODULE =================

model Supplier {
  id         String      @id @default(cuid())
  name       String
  contact    String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  spareParts SparePart[]
  purchases  Purchase[]
}

model Category {
  id         String      @id @default(cuid())
  name       String      @unique
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  spareParts SparePart[]
}

model SparePart {
  id         String           @id @default(cuid())
  code       String           @unique
  name       String
  category   String
  categoryId String?
  categoryRel Category?       @relation(fields: [categoryId], references: [id])
  unit       String           @default("Pcs")
  stock      Int              @default(0)
  minStock   Int              @default(0)
  costPrice  Decimal          @db.Decimal(12, 2)
  supplier   Supplier?        @relation(fields: [supplierId], references: [id])
  supplierId String?
  version    Int              @default(1)
  isDeleted  Boolean          @default(false)
  deletedAt  DateTime?
  sellPrices SellPrice[]
  audits     InventoryAudit[]
  purchases  Purchase[]
  visitItems VisitItem[]
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model SellPrice {
  id            String    @id @default(cuid())
  sparePart     SparePart @relation(fields: [sparePartId], references: [id])
  sparePartId   String
  brand         String
  price         Decimal   @db.Decimal(12, 2)
  note          String?
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  createdBy     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([sparePartId, brand])
  @@index([sparePartId])
}

model InventoryAudit {
  id          String    @id @default(cuid())
  sparePart   SparePart @relation(fields: [sparePartId], references: [id])
  sparePartId String
  delta       Int
  before      Int
  after       Int
  reason      String
  referenceId String?
  performedBy String?
  createdAt   DateTime  @default(now())
}

model Purchase {
  id                 String    @id @default(cuid())
  sparePart          SparePart? @relation(fields: [sparePartId], references: [id])
  sparePartId        String?
  sparePartCode      String?
  sparePartName      String?
  quantity           Int
  unitPrice          Decimal   @default(0) @db.Decimal(12, 2)
  discount           Decimal   @default(0) @db.Decimal(12, 2)
  costPrice          Decimal   @db.Decimal(12, 2)
  supplier           Supplier? @relation(fields: [supplierId], references: [id])
  supplierId         String?
  supplierRefNumber  String?
  purchaseDate       DateTime  @default(now())
  createdBy          String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([sparePartId])
  @@index([supplierId])
}

model AuditLog {
  id          String   @id @default(cuid())
  entity      String
  entityId    String
  action      String
  diff        Json?
  performedBy String?
  createdAt   DateTime @default(now())
}

model VisitItem {
  id          String    @id @default(cuid())
  visitId     String
  visit       Visit     @relation(fields: [visitId], references: [id], onDelete: Cascade)
  sparePartId String
  sparePart   SparePart @relation(fields: [sparePartId], references: [id])
  quantity    Int       @default(1)
  price       Float     @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([visitId])
  @@index([sparePartId])
}

model SystemCounter {
  key   String @id
  value Int    @default(0)
}
